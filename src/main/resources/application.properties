# Kafka Sidecar Service Configuration
quarkus.application.name=pipestream-engine-kafka-sidecar
quarkus.application.version=1.0.0-SNAPSHOT

# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Kafka Sidecar service port (38104)
quarkus.http.host=0.0.0.0
quarkus.http.port=38104

# HTTP body size limit - 2GB to match gRPC limits for large documents
quarkus.http.limits.max-body-size=2G
quarkus.grpc.server.use-separate-server=true
quarkus.grpc.server.port=48104
quarkus.grpc.server.enable-health-service=true
quarkus.grpc.server.enable-reflection-service=true
quarkus.grpc.server.max-inbound-message-size=2147483647

# Enable virtual threads for gRPC (JDK 21+)
quarkus.grpc.server.use-virtual-threads=true

# gRPC Flow Control - 50MB window for large messages
quarkus.grpc.server.flow-control-window=52428800

# gRPC client configuration for engine and repo-service
quarkus.grpc.clients."*".max-inbound-message-size=2147483647
quarkus.grpc.clients."*".flow-control-window=52428800

# Dev configuration
%dev.quarkus.http.port=38104

# Test configuration
%test.quarkus.http.test-port=0
%test.quarkus.grpc.server.use-separate-server=false

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
pipestream.registration.enabled=true
%test.pipestream.registration.enabled=false
pipestream.registration.service-name=kafka-sidecar
pipestream.registration.description=Kafka consumer sidecar that hydrates documents and hands off to engine
pipestream.registration.type=SERVICE
pipestream.registration.advertised-host=${SERVICE_REGISTRATION_ADVERTISED_HOST:host.docker.internal}
pipestream.registration.advertised-port=${quarkus.grpc.server.port}
pipestream.registration.internal-host=${SERVICE_REGISTRATION_INTERNAL_HOST:172.17.0.1}
pipestream.registration.internal-port=${quarkus.grpc.server.port}
pipestream.registration.capabilities=kafka-consumer,document-hydration,engine-handoff
pipestream.registration.tags=sidecar,kafka,hydration

# Registration service connection (platform-registration-service)
pipestream.registration.registration-service.host=localhost
pipestream.registration.registration-service.port=38101

# ======================================================================================================================
# Consul Configuration (for dynamic topic subscription)
# ======================================================================================================================
quarkus.consul.host=${CONSUL_HOST:localhost}
quarkus.consul.port=${CONSUL_PORT:8500}

# ======================================================================================================================
# Dev Services Configuration
# ======================================================================================================================
# General Dev Services
%dev.quarkus.devservices.enabled=true

# Docker Compose Dev Services (Dev Profile) - Use shared dev services via extension
%dev.quarkus.compose.devservices.enabled=true
%dev.quarkus.compose.devservices.files=${user.home}/.pipeline/compose-devservices.yml
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.reuse-project-for-tests=true
%dev.quarkus.devservices.timeout=120s

# Kafka Dev Services
%dev.quarkus.kafka.devservices.enabled=true

# ======================================================================================================================
# Kafka Configuration (Consumer - sidecar consumes, engine produces)
# ======================================================================================================================
kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}

# Apicurio Registry configuration
# For manual Kafka consumers, the Apicurio DevServices extension doesn't auto-detect the need,
# so we must set it explicitly. Compose DevServices exposes apicurio-registry on port 8081.
# In production, set via APICURIO_REGISTRY_URL environment variable.
%dev.apicurio.registry.url=http://localhost:8081/apis/registry/v3

# ----- Sidecar Kafka Consumer Configuration -----
# NOTE: The sidecar uses MANUAL Kafka consumers via smallrye-mutiny-vertx-kafka-client
# (created in ConsumerManager), NOT Reactive Messaging @Incoming channels.
# The Apicurio extension auto-configures Protobuf deserialization for manual consumers.
# Topics are managed dynamically via Consul lease management.
# NO Reactive Messaging channel configuration needed - we use manual consumers only

# Sidecar Kafka consumer loop (ConsumerManager)
pipestream.sidecar.consumer.enabled=true
%test.pipestream.sidecar.consumer.enabled=false

# Retry/backoff policy for end-to-end processing (hydrate -> validate -> engine)
# (DLQ behavior handled in ConsumerManager failure path; Phase 2 will publish to DLQ.)
pipestream.sidecar.processing.max-retries=3
pipestream.sidecar.processing.backoff.initial-ms=25
pipestream.sidecar.processing.backoff.max-ms=250

# Faster retries in tests
%test.pipestream.sidecar.processing.max-retries=2
%test.pipestream.sidecar.processing.backoff.initial-ms=5
%test.pipestream.sidecar.processing.backoff.max-ms=25

# ======================================================================================================================
# gRPC Client Configuration (for calling Engine and RepoService)
# ======================================================================================================================
# Use Stork service discovery for gRPC clients
# This allows WireMockTestResource to override via stork.* config

# Engine service - for document handoff after hydration
quarkus.grpc.clients.engine.use-quarkus-grpc-client=true
quarkus.grpc.clients.engine.host=stork://engine

# RepoService - for fetching document blobs during hydration
quarkus.grpc.clients.repo-service.use-quarkus-grpc-client=true
quarkus.grpc.clients.repo-service.host=stork://repo-service

# Default Stork static discovery - Dev/Prod mode
stork.engine.service-discovery.type=static
stork.engine.service-discovery.address-list=${ENGINE_HOST:localhost}:${ENGINE_PORT:38100}
stork.repo-service.service-discovery.type=static
stork.repo-service.service-discovery.address-list=${REPO_SERVICE_HOST:localhost}:${REPO_SERVICE_PORT:38102}

# Test profile: WireMockTestResource will override stork.* config

# ======================================================================================================================
# Logging Configuration
# ======================================================================================================================
quarkus.log.level=INFO
quarkus.log.category."ai.pipestream.sidecar".level=INFO
quarkus.log.category."io.vertx.ext.consul".level=WARN
%dev.quarkus.log.console.level=INFO
%dev.quarkus.log.category."io.quarkus.grpc".level=WARN
%dev.quarkus.log.category."io.smallrye.stork".level=WARN
%dev.quarkus.log.category."org.apache.kafka".level=WARN

# Health checks
quarkus.smallrye-health.root-path=/q/health
quarkus.smallrye-health.liveness-path=/q/health/live
quarkus.smallrye-health.readiness-path=/q/health/ready

# ======================================================================================================================
# Micrometer/Prometheus Metrics Configuration
# ======================================================================================================================
quarkus.micrometer.binder.http-server.enabled=true
quarkus.micrometer.binder.kafka.enabled=true
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.export.prometheus.path=/q/metrics

# ======================================================================================================================
# OpenTelemetry Tracing Configuration
# ======================================================================================================================
quarkus.otel.enabled=true
quarkus.otel.exporter.otlp.endpoint=${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4317}
%dev.quarkus.otel.enabled=false
%test.quarkus.otel.enabled=false

# ======================================================================================================================
# Container Image Configuration
# ======================================================================================================================
quarkus.container-image.registry=git.rokkon.com
quarkus.container-image.group=io-pipeline
quarkus.container-image.name=pipestream-engine-kafka-sidecar
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}

# Jandex indexing for third-party and internal dynamic gRPC libraries
quarkus.index-dependency.apicurio-registry.group-id=io.apicurio
quarkus.index-dependency.apicurio-registry.artifact-id=apicurio-registry-protobuf-serde-kafka
quarkus.index-dependency.pipestream-registration.group-id=ai.pipestream
quarkus.index-dependency.pipestream-registration.artifact-id=pipestream-service-registration
quarkus.index-dependency.pipestream-dynamic-grpc.group-id=ai.pipestream
quarkus.index-dependency.pipestream-dynamic-grpc.artifact-id=quarkus-dynamic-grpc
