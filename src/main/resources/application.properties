# Kafka Sidecar Service Configuration
quarkus.application.name=engine-kafka-sidecar

# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Kafka Sidecar service port (38104). Context path matches app root name.
quarkus.http.host=0.0.0.0
quarkus.http.port=38104
quarkus.http.root-path=/engine-kafka-sidecar

# Test configuration
%test.quarkus.http.test-port=0
%test.quarkus.grpc.server.use-separate-server=false

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
pipestream.registration.enabled=true
%test.pipestream.registration.enabled=false
pipestream.registration.service-name=engine-kafka-sidecar
pipestream.registration.type=SERVICE
pipestream.registration.description=Kafka consumer sidecar that hydrates documents and hands off to engine
pipestream.registration.capabilities=kafka-consumer,document-hydration,engine-handoff
pipestream.registration.tags=sidecar,kafka,hydration
# Pipestream server defaults
pipestream.server.class=engine


# ======================================================================================================================
# Kafka Configuration (Consumer - sidecar consumes, engine produces)
# ======================================================================================================================
## Test: DevServices auto-configures kafka.bootstrap.servers
%prod.kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:kafka:9092}

# Apicurio Registry configuration
# For manual Kafka consumers, the Apicurio DevServices extension doesn't auto-detect the need,
# so we must set it explicitly. Compose DevServices exposes apicurio-registry on port 8081.
# In production, set via APICURIO_REGISTRY_URL environment variable.
%dev.apicurio.registry.url=http://localhost:8081/apis/registry/v3
## NOTE: this is automatically set for DEV environments

# Kafka Dev Services
%dev.quarkus.kafka.devservices.enabled=true
%dev.kafka.bootstrap.servers=localhost:9094

# ----- Sidecar Kafka Consumer Configuration -----
# NOTE: The sidecar uses MANUAL Kafka consumers via smallrye-mutiny-vertx-kafka-client
# (created in ConsumerManager), NOT Reactive Messaging @Incoming channels.
# The Apicurio extension auto-configures Protobuf deserialization for manual consumers.
# Topics are managed dynamically via Consul lease management.
# NO Reactive Messaging channel configuration needed - we use manual consumers only

# Sidecar Kafka consumer loop (ConsumerManager)
pipestream.sidecar.consumer.enabled=true
%test.pipestream.sidecar.consumer.enabled=false

# Retry/backoff policy for end-to-end processing (hydrate -> validate -> engine)
# (DLQ behavior handled in ConsumerManager failure path; Phase 2 will publish to DLQ.)
pipestream.sidecar.processing.max-retries=3
pipestream.sidecar.processing.backoff.initial-ms=25
pipestream.sidecar.processing.backoff.max-ms=250

# Faster retries in tests
%test.pipestream.sidecar.processing.max-retries=2
%test.pipestream.sidecar.processing.backoff.initial-ms=5
%test.pipestream.sidecar.processing.backoff.max-ms=25

# ======================================================================================================================
# gRPC Client Configuration (for calling Engine and RepoService)
# ======================================================================================================================
# Use Stork service discovery for gRPC clients
# This allows WireMockTestResource to override via stork.* config

# Engine service - for document handoff after hydration
quarkus.grpc.clients.engine.use-quarkus-grpc-client=true
quarkus.grpc.clients.engine.host=stork://engine

# RepoService - for fetching document blobs during hydration
quarkus.grpc.clients.repo-service.use-quarkus-grpc-client=true
quarkus.grpc.clients.repo-service.host=stork://repo-service

# Default Stork static discovery - Dev/Prod mode
stork.engine.service-discovery.type=static
stork.engine.service-discovery.address-list=${ENGINE_HOST:localhost}:${ENGINE_PORT:38100}
stork.repo-service.service-discovery.type=static
stork.repo-service.service-discovery.address-list=${REPO_SERVICE_HOST:localhost}:${REPO_SERVICE_PORT:38102}

# Test profile: WireMockTestResource will override stork.* config

# ======================================================================================================================
# Logging Configuration
# ======================================================================================================================
quarkus.log.level=INFO
quarkus.log.category."ai.pipestream.sidecar".level=INFO
quarkus.log.category."io.vertx.ext.consul".level=WARN
%dev.quarkus.log.console.level=INFO
%dev.quarkus.log.category."io.quarkus.grpc".level=WARN
%dev.quarkus.log.category."io.smallrye.stork".level=WARN
%dev.quarkus.log.category."org.apache.kafka".level=WARN

# Health checks
quarkus.smallrye-health.root-path=/q/health
quarkus.smallrye-health.liveness-path=/q/health/live
quarkus.smallrye-health.readiness-path=/q/health/ready

# ======================================================================================================================
# Micrometer/Prometheus Metrics Configuration
# ======================================================================================================================
quarkus.micrometer.binder.http-server.enabled=true
quarkus.micrometer.binder.kafka.enabled=true
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.export.prometheus.path=/q/metrics

# ======================================================================================================================
# OpenTelemetry Tracing Configuration
# ======================================================================================================================
quarkus.otel.enabled=true
quarkus.otel.exporter.otlp.endpoint=${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4317}
%dev.quarkus.otel.enabled=false
%test.quarkus.otel.enabled=false

# ======================================================================================================================
# Container Image Configuration
# ======================================================================================================================
quarkus.container-image.registry=docker.io
quarkus.container-image.group=io-pipeline
quarkus.container-image.name=pipestream-engine-kafka-sidecar
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}

